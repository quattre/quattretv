{% extends 'portal/layouts/base.html' %}

{% block title %}Dispositivos de {{ view_user.username }} - QuattreTV Portal{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'portal:users' %}">Usuarios</a></li>
            <li class="breadcrumb-item"><a href="{% url 'portal:user_edit' view_user.id %}">{{ view_user.username }}</a></li>
            <li class="breadcrumb-item active">Dispositivos</li>
        </ol>
    </nav>
    <h1><i class="bi bi-phone"></i> Dispositivos de {{ view_user.username }}</h1>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    Este usuario tiene <strong>{{ devices.count }}/{{ view_user.max_devices }}</strong> dispositivos registrados.
</div>

<div class="data-table">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>MAC Address</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Última IP</th>
                <th>Última conexión</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td><code>{{ device.mac_address }}</code></td>
                <td>{{ device.name|default:"-" }}</td>
                <td>{{ device.get_device_type_display }}</td>
                <td>{{ device.last_ip|default:"-" }}</td>
                <td>{{ device.last_seen|timesince|default:"Nunca" }}</td>
                <td>
                    {% if device.is_online %}
                        <span class="status-badge status-online">Online</span>
                    {% else %}
                        <span class="status-badge status-offline">Offline</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'portal:device_edit' device.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice({{ device.id }})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    Este usuario no tiene dispositivos registrados
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<a href="{% url 'portal:user_edit' view_user.id %}" class="btn btn-secondary mt-3">
    <i class="bi bi-arrow-left"></i> Volver al usuario
</a>
{% endblock %}

{% block extra_js %}
<script>
function deleteDevice(deviceId) {
    if (confirm('¿Eliminar este dispositivo?')) {
        fetch(`/portal/devices/${deviceId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %}
