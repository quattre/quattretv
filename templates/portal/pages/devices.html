{% extends 'portal/layouts/base.html' %}

{% block title %}Dispositivos - QuattreTV Portal{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i class="bi bi-phone"></i> Dispositivos
        </h1>
        <p class="text-gray-500 mt-1">Gestion de STBs y dispositivos registrados</p>
    </div>
    <button
        x-data
        @click="$dispatch('open-add-device-modal')"
        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2"
    >
        <i class="bi bi-plus-lg"></i> Nuevo Dispositivo
    </button>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold text-gray-800">{{ stats.total }}</h3>
                <p class="text-gray-500 text-sm">Total Dispositivos</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-phone text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold text-gray-800">{{ stats.online }}</h3>
                <p class="text-gray-500 text-sm">Online Ahora</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-wifi text-green-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold text-gray-800">{{ stats.mag }}</h3>
                <p class="text-gray-500 text-sm">MAG/STB</p>
            </div>
            <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-tv text-cyan-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold text-gray-800">{{ stats.apps }}</h3>
                <p class="text-gray-500 text-sm">Apps (Android/iOS)</p>
            </div>
            <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-phone text-amber-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div class="md:col-span-4">
            <input
                type="text"
                name="search"
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Buscar MAC, usuario..."
                value="{{ request.GET.search }}"
            >
        </div>
        <div class="md:col-span-3">
            <select name="type" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todos los tipos</option>
                <option value="mag" {% if request.GET.type == 'mag' %}selected{% endif %}>MAG STB</option>
                <option value="android" {% if request.GET.type == 'android' %}selected{% endif %}>Android</option>
                <option value="ios" {% if request.GET.type == 'ios' %}selected{% endif %}>iOS</option>
                <option value="smart_tv" {% if request.GET.type == 'smart_tv' %}selected{% endif %}>Smart TV</option>
            </select>
        </div>
        <div class="md:col-span-3">
            <select name="status" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todos los estados</option>
                <option value="online" {% if request.GET.status == 'online' %}selected{% endif %}>Online</option>
                <option value="offline" {% if request.GET.status == 'offline' %}selected{% endif %}>Offline</option>
            </select>
        </div>
        <div class="md:col-span-2">
            <button type="submit" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition flex items-center justify-center gap-2">
                <i class="bi bi-search"></i> Filtrar
            </button>
        </div>
    </form>
</div>

<!-- Devices Table -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100">
        <h5 class="font-semibold text-gray-800">{{ devices.count }} dispositivos encontrados</h5>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">MAC Address</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Usuario</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tipo</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ultima IP</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ultima conexion</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for device in devices %}
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <code class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">{{ device.mac_address }}</code>
                        {% if device.name %}
                            <br><span class="text-gray-400 text-sm">{{ device.name }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <a href="{% url 'portal:user_edit' device.user.id %}" class="text-blue-500 hover:text-blue-700 hover:underline">{{ device.user.username }}</a>
                    </td>
                    <td class="px-6 py-4">
                        {% if device.device_type == 'mag' %}
                            <span class="px-3 py-1 text-xs rounded-full bg-gray-800 text-white inline-flex items-center gap-1">
                                <i class="bi bi-tv"></i> MAG
                            </span>
                        {% elif device.device_type == 'android' %}
                            <span class="px-3 py-1 text-xs rounded-full bg-green-100 text-green-700 inline-flex items-center gap-1">
                                <i class="bi bi-android2"></i> Android
                            </span>
                        {% elif device.device_type == 'ios' %}
                            <span class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-700 inline-flex items-center gap-1">
                                <i class="bi bi-apple"></i> iOS
                            </span>
                        {% elif device.device_type == 'smart_tv' %}
                            <span class="px-3 py-1 text-xs rounded-full bg-cyan-100 text-cyan-700 inline-flex items-center gap-1">
                                <i class="bi bi-display"></i> Smart TV
                            </span>
                        {% else %}
                            <span class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-700">{{ device.get_device_type_display }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-gray-600">{{ device.last_ip|default:"-" }}</td>
                    <td class="px-6 py-4 text-gray-600">
                        {% if device.last_seen %}
                            {{ device.last_seen|timesince }} atras
                        {% else %}
                            Nunca
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        {% if device.is_online %}
                            <span class="px-3 py-1 text-xs rounded-full bg-green-100 text-green-700 inline-flex items-center gap-1">
                                <i class="bi bi-circle-fill text-[8px]"></i> Online
                            </span>
                        {% else %}
                            <span class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-500">Offline</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            <a href="{% url 'portal:device_edit' device.id %}" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button class="p-2 text-amber-500 hover:bg-amber-50 rounded-lg transition" onclick="refreshToken({{ device.id }})" title="Regenerar token">
                                <i class="bi bi-key"></i>
                            </button>
                            <button
                                class="p-2 text-cyan-500 hover:bg-cyan-50 rounded-lg transition"
                                @click="$dispatch('open-message-modal', { deviceId: {{ device.id }} })"
                                title="Enviar mensaje"
                            >
                                <i class="bi bi-chat"></i>
                            </button>
                            <button class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition" onclick="deleteDevice({{ device.id }})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-400">
                        <i class="bi bi-inbox text-5xl block mb-3"></i>
                        <p>No hay dispositivos registrados</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Device Modal -->
<div
    x-data="{ open: false }"
    @open-add-device-modal.window="open = true"
    @keydown.escape.window="open = false"
>
    <div
        x-show="open"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black/50 z-40"
        @click="open = false"
        x-cloak
    ></div>
    <div
        x-show="open"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
        x-cloak
    >
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md" @click.stop>
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                <h5 class="font-semibold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-phone-fill text-blue-500"></i> Nuevo Dispositivo
                </h5>
                <button @click="open = false" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form method="post" action="{% url 'portal:device_create' %}">
                {% csrf_token %}
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">MAC Address *</label>
                        <input
                            type="text"
                            name="mac_address"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="00:1A:79:XX:XX:XX"
                            required
                        >
                        <p class="text-gray-400 text-xs mt-1">Formato: XX:XX:XX:XX:XX:XX</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Usuario *</label>
                        <select name="user" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Seleccionar usuario...</option>
                            {% for user in all_users %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de dispositivo</label>
                        <select name="device_type" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="mag">MAG STB</option>
                            <option value="android">Android</option>
                            <option value="ios">iOS</option>
                            <option value="smart_tv">Smart TV</option>
                            <option value="web">Web Browser</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre (opcional)</label>
                        <input
                            type="text"
                            name="name"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Ej: Salon, Habitacion..."
                        >
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-xl">
                    <button type="button" @click="open = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        Crear Dispositivo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div
    x-data="{ open: false, deviceId: null }"
    @open-message-modal.window="open = true; deviceId = $event.detail.deviceId"
    @keydown.escape.window="open = false"
>
    <div
        x-show="open"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black/50 z-40"
        @click="open = false"
        x-cloak
    ></div>
    <div
        x-show="open"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
        x-cloak
    >
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md" @click.stop>
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                <h5 class="font-semibold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-chat text-blue-500"></i> Enviar Mensaje
                </h5>
                <button @click="open = false" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form method="post" id="sendMessageForm">
                {% csrf_token %}
                <input type="hidden" name="device_id" :value="deviceId">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de mensaje</label>
                        <select name="message_type" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="info">Informacion</option>
                            <option value="warning">Advertencia</option>
                            <option value="error">Error</option>
                            <option value="reload">Recargar Portal</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Titulo</label>
                        <input
                            type="text"
                            name="title"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje</label>
                        <textarea
                            name="message"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            required
                        ></textarea>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-xl">
                    <button type="button" @click="open = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshToken(deviceId) {
    if (confirm('Regenerar token de este dispositivo? El dispositivo debera reconectarse.')) {
        fetch(`/portal/devices/${deviceId}/refresh-token/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).then(response => {
            if (response.ok) {
                alert('Token regenerado');
                location.reload();
            }
        });
    }
}

function deleteDevice(deviceId) {
    if (confirm('Eliminar este dispositivo?')) {
        fetch(`/portal/devices/${deviceId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %}
